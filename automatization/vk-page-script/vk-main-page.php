<?php

/* â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— 
   â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ 
    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ 
     â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â•  â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â• 
      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  
      â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•  â•šâ•â•â•â•      â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•  â•šâ•â•â•â•   */

if (isset($_GET['status'])) {

$token = '#TOKEN#';

function GetPlatformVK() {

    $result = "ðŸ’» Computer";
    $params = array('fields' => 'last_seen',
                  'user_ids' => '245855787',
                 'name_case' => 'Nom',
              'access_token' => $GLOBALS["token"],
                         'v' => '5.0');
    
    $params = http_build_query($params);
    $query = file_get_contents('https://api.vk.com/method/users.get?'.$params);
    $result = json_decode($query, true);
    
    switch ($result['response']['0']['last_seen']['platform']) {

        case 1: $GLOBALS["platform"] = "ðŸ“± Mobile Version";
        break;
        case 2: $GLOBALS["platform"] = "ðŸ Iphone";
        break;
        case 3: $GLOBALS["platform"] = "ðŸ“Ÿ Ipad";
        break;
        case 4: $GLOBALS["platform"] = "ðŸ“± Android";
        break;
        case 5: $GLOBALS["platform"] = "ðŸ“± Windows Phone";
        break;
        case 6: $GLOBALS["platform"] = "ðŸ’» Windows 10";
        break;
        case 7: $GLOBALS["platform"] = "ðŸ’» Computer";
        break;
        default: $GLOBALS["platform"] = "ðŸ’» Computer";
        break;
    }
    
} GetPlatformVK(); // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñƒ

/*                          ---------------------------------------------------------                                */

function SetStatusForVK() {

    date_default_timezone_set("Europe/Kiev");

    $text      = $GLOBALS["platform"]." | ðŸ“… ".date("d.m.Y")." | âŒš ".date("H:i");
    /* $zamena_iz = array("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10");
    $zamena_na = array("0âƒ£", "1âƒ£", "2âƒ£", "3âƒ£", "4âƒ£", "5âƒ£", "6âƒ£", "7âƒ£", "8âƒ£", "9âƒ£", "ðŸ”Ÿ"); */
    $text      = str_replace($zamena_iz, $zamena_na, $text);
    $params    = array('text' => $text, 'access_token' => $GLOBALS["token"], 'v' => '5.0');
    $params = http_build_query($params);
    $query  = file_get_contents('https://api.vk.com/method/status.set?'.$params);
    $result = json_decode($query, true);
    //print_r($result);

} SetStatusForVK(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ

/*                          ---------------------------------------------------------                                */

function SetOnlineForVK() { 
    
    $params = array('access_token' => $GLOBALS["token"], 'v' => '5.0');

    $params = http_build_query($params);
    $query = file_get_contents('https://api.vk.com/method/account.setOnline?'.$params);
    $result = json_decode($query, true);
    //echo "Online test";
    //print_r($result);
    
} SetOnlineForVK(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¾Ð½Ð»Ð°Ð¹Ð½ Ñ ÐŸÐš

} // status


/*                          ---------------------------------------------------------                                */


if (isset($_GET['VKlogger'])) {

/*Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€*/
function LongPollServer() { 

    $params = array('access_token' => $GLOBALS["token"],
                            'v'            => '5.87');
    $params = http_build_query($params);
    $query = file_get_contents('https://api.vk.com/method/messages.getLongPollServer?'.$params);
    $result = json_decode($query, true);

    $GLOBALS["key"]    = $result['response']['key'];
    $GLOBALS["server"] = $result['response']['server'];
    $GLOBALS["ts"]     = file_get_contents("ts.txt");
    $GLOBALS["new_ts"] = $result['response']['ts'];

// echo "TS: ".$GLOBALS["ts"]."<br/>"."Server: ".$GLOBALS["server"]."<br/>"."Key: ".$GLOBALS["key"]."<br/>"."<br/>";
    
}

/*                          ---------------------------------------------------------                                */

/*ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€*/
function LongPollHistory() {

    $params = array('key'            => $GLOBALS["key"],
                    'ts'             => $GLOBALS["ts"],
                    'access_token'   => $GLOBALS["token"],
                    'v'              => '5.87');
    $params = http_build_query($params);
    $query = file_get_contents('https://api.vk.com/method/messages.getLongPollHistory?act=a_check&'.$params);
    $result = json_decode($query, true);
    print_r($query);
    $GLOBALS["check_update"] = $result["response"]["history"];
    // $GLOBALS["check_msg_update"] = $result["response"]["messages"]["items"][0];
        
    foreach ($result["response"]["messages"]["items"] as $index => $elem) {
        $GLOBALS["check_msg_update"][$index] = $result["response"]["messages"]["items"][$index];
    }

    print_r($GLOBALS["check_msg_update"]);
    
}

/*                          ---------------------------------------------------------                                */

/*ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð½Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ/Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ/ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ*/
function CheckMessageUpdate() {

    date_default_timezone_set("Europe/Moscow");

    $historyListJSON = file_get_contents("messagesHistory.json");
    $historyList = json_decode($historyListJSON, TRUE);

    foreach ($GLOBALS["check_msg_update"] as $index0 => $elem0) {

    if (isset($GLOBALS["check_msg_update"][$index0]["update_time"])) {

    foreach ($historyList as $index => $elem) {

       foreach ($historyList[$index] as $index2 => $elem2) {

            if ($historyList[$index][$index2]["id"] == $GLOBALS["check_msg_update"][$index0]["id"]) {

               //if ($historyList[$index][$index2]["text"] != $GLOBALS["check_msg_update"]["text"]) {

                   $old = $historyList[$index][$index2]["text"];
                   $new = $GLOBALS["check_msg_update"][$index0]["text"];
                   $mid = $historyList[$index][$index2]["id"];
                   $uid = $GLOBALS["check_msg_update"][$index0]["from_id"];
                   $bid = $GLOBALS["check_msg_update"][$index0]["peer_id"];
                 
                   /* Ð¢ÐµÑÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¼Ñ Ð¾Ñ‚ Ð»Ð¸Ñ†Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ */
                   $params = array('message'      => "ðŸ“ŸVK-Logger | ðŸ“…".date("d.m.Y")." | âŒš".date("H:i:s")."\n[id".$uid."| ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ] Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð» ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ (ðŸ†”".$mid.")\nðŸ”™: ".$old."\nðŸ†•: ".$new."\nâ†ª: https://vk.com/im?sel=".$bid."&msgid=".$mid,
                                   'user_id'      => '245855787',
                                   'group_id'     => '176736665',
                                   'access_token' => $GLOBALS["token"],
                                   'v'            => '5.87');

                   $params = http_build_query($params);
                   $query = file_get_contents('https://api.vk.com/method/messages.send?'.$params);
                   //echo "<br/><br/>Soobcheniye o loge otrpavleno v ls SUKAA BLYAAAAAAT";
                   break;
               } 
           } // second foreach
         } // first foreach
       } else { continue; }
    }

    foreach ($GLOBALS["check_update"] as $index7 => $elem7) {

        if ($GLOBALS["check_update"][$index7][2] == "131200") {

            foreach ($historyList as $index => $elem) {

                foreach ($historyList[$index] as $index2 => $elem2) {
         
                     if ($historyList[$index][$index2]["id"] == $GLOBALS["check_update"][$index7][1]) {
         
                        //if ($historyList[$index][$index2]["text"] != $GLOBALS["check_msg_update"]["text"]) {
         
                            $old = $historyList[$index][$index2]["text"];
                            $mid = $historyList[$index][$index2]["id"];
                            $uid = $historyList[$index][$index2]["from_id"];
                            $bid = $GLOBALS["check_update"][$index7][3];
                          
                            /* Ð¢ÐµÑÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¼Ñ Ð¾Ñ‚ Ð»Ð¸Ñ†Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ */
                            $params = array('message'      => "ðŸ“ŸVK-Logger | ðŸ“…".date("d.m.Y")." | âŒš".date("H:i:s")."\n[id".$uid."| ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ] ÑƒÐ´Ð°Ð»Ð¸Ð» ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ (ðŸ†”".$mid.")\nâœ‰: ".$old."\nâ†ª: https://vk.com/im?sel=".$bid,
                                            'user_id'      => '245855787',
                                            'group_id'     => '176736665',
                                            'access_token' => $GLOBALS["token"],
                                            'v'            => '5.87');
            
                            $params = http_build_query($params);
                            $query = file_get_contents('https://api.vk.com/method/messages.send?'.$params);
                            //echo "<br/><br/>Soobcheniye o loge otrpavleno v ls SUKAA BLYAAAAAAT";
                            break;
                        } 
                    } // second foreach
                  } // first foreach
        }
    }
} 

/*                          ---------------------------------------------------------                                */

/*ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð°Ð¹Ð´Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð½Ð°Ñ‚ÑŒ Ð¸Ð· ÐºÐ°ÐºÐ¾Ð³Ð¾ Ð´Ð¸Ð°Ð»Ð¾Ð³a Ð²Ñ‹ÑÑ‚Ñ‘Ð³Ð¸Ð²Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð¼ messages.getHistory*/  
function GetDialogs() { 

    $params = array('count'        => '10',
                    'access_token' => $GLOBALS["token"],
                    'v'            => '5.87');
    $params = http_build_query($params);
    $query = file_get_contents('https://api.vk.com/method/messages.getDialogs?'.$params);

    $dialogList = json_decode($query,TRUE); // Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð¼Ð°ÑÑÐ¸Ð²

    $GLOBALS["users_id"] = array();
    $test_i              = 0;

    foreach ($dialogList["response"]["items"] as $index => $elem) {

        if (isset($dialogList["response"]["items"][$index]["message"]["chat_id"])) {$GLOBALS["users_id"][$test_i] = array(2000000000 + (int) $dialogList["response"]["items"][$index]["message"]["chat_id"]);}
        else {$GLOBALS["users_id"][$test_i] = array($dialogList["response"]["items"][$index]["message"]["user_id"]);}
        $test_i++;
    }
} 

/*                          ---------------------------------------------------------                                */

function addToArray($uID) {

    $params = array('count'        => '100',
                    'fields'       => 'id,first_name,last_name',
                    'extended'     => '1',
                    'user_id'      => $uID,
                    'access_token' => $GLOBALS["token"],
                    'v'            => '5.87');
    $params = http_build_query($params);
    $query = file_get_contents('https://api.vk.com/method/messages.getHistory?'.$params);
    $msgArray = json_decode($query,TRUE);

    foreach ($msgArray as $tIndex => $tElement) {
        $newTestArr = $msgArray["response"];
    }

    return $newTestArr;
}

/*                          ---------------------------------------------------------                                */

/*ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐµÐµ Ð² ÑÐ²Ð¾Ð¹ json Ñ„Ð°Ð¹Ð»*/
function GetHistory() { 
  
    $GLOBALS["messagesHistoryArr"] = array();

    foreach ($GLOBALS["users_id"] as $index => $elem) {
        $GLOBALS["messagesHistoryArr"][$index] = addToArray($GLOBALS["users_id"][$index][0]);
    }

    foreach ($GLOBALS["messagesHistoryArr"] as $testIndex => $testElement) {
        $arr_to_json[$testIndex] = $GLOBALS["messagesHistoryArr"][$testIndex]['items'];
    }
    
    file_put_contents("messagesHistory.json", json_encode($arr_to_json, TRUE));
}

/* Ð¢ÐµÑÑ‚ Ð»Ð¾Ð³Ð³ÐµÑ€Ð° */
/* 
LongPollServer(); 
sleep(1);
LongPollHistory();
sleep(1);
    
if ($GLOBALS["check_update"][0] == Array()) {file_put_contents("ts.txt", $GLOBALS["new_ts"]); return;} //continue;
    
CheckMessageUpdate();
sleep(1);
GetDialogs(); //ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð°Ð¹Ð´Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð½Ð°Ñ‚ÑŒ Ð¸Ð· ÐºÐ°ÐºÐ¾Ð³Ð¾ Ð´Ð¸Ð°Ð»Ð¾Ð³a Ð²Ñ‹ÑÑ‚Ñ‘Ð³Ð¸Ð²Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð¼ messages.getHistory 
sleep(1);
GetHistory(); //ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐµÐµ Ð² ÑÐ²Ð¾Ð¹ json Ñ„Ð°Ð¹Ð»
file_put_contents("ts.txt", $GLOBALS["new_ts"]); */
} // vk logger

?>